<!DOCTYPE html>
<html>
<head>
    <title>Árbol Sintáctico - Compilador</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .node circle { fill: #6baed6; stroke: #3182bd; stroke-width: 1.5px; }
        .node text { font-size: 12px; font-weight: bold; }
        .link { fill: none; stroke: #ccc; stroke-width: 1.5px; }
        .node rect { fill: #4CAF50; stroke: #388E3C; stroke-width: 2px; rx: 5; ry: 5; }
        .node text { fill: white; font-weight: bold; }
        .node.leaf rect { fill: #2196F3; }
        .node.root rect { fill: #FF9800; }
        .controls { margin: 20px 0; }
        button { padding: 10px 15px; margin: 5px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1> Árbol Sintáctico Generado</h1>
    <div class="controls">
        <button onclick="zoomIn()">+ Zoom In</button>
        <button onclick="zoomOut()">- Zoom Out</button>
        <button onclick="resetZoom()"> Reset</button>
        <button onclick="downloadSVG()">Descarga del grafico</button>
    </div>
    <div id="tree-container"></div>
    <script>
        const treeData = {"name":"PROGRAM", "value":"", "children": [{"name":"GLOBALES", "value":"", "children": [{"name":"DECL_GLOBAL", "value":"contador", "children": [{"name":"TIPO", "value":"int"}]}, {"name":"DECL_GLOBAL", "value":"valor", "children": [{"name":"TIPO", "value":"float"}, {"name":"LITERAL_FLOAT", "value":"3.14"}]}, {"name":"DECL_GLOBAL", "value":"letra", "children": [{"name":"TIPO", "value":"char"}, {"name":"LITERAL_CHAR", "value":"x"}]}]}, {"name":"MAIN", "value":"navidad", "children": [{"name":"BLOQUE", "value":"", "children": [{"name":"SENTENCIAS", "value":"", "children": [{"name":"DECL_LOCAL", "value":"num1", "children": [{"name":"TIPO", "value":"int"}, {"name":"LITERAL_INT", "value":"5"}]}, {"name":"DECL_LOCAL", "value":"num2", "children": [{"name":"TIPO", "value":"int"}, {"name":"LITERAL_INT", "value":"10"}]}, {"name":"DECL_LOCAL", "value":"resultado", "children": [{"name":"TIPO", "value":"bool"}, {"name":"OPERACION", "value":">", "children": [{"name":"IDENT", "value":"num1"}, {"name":"OPERACION", "value":"%", "children": [{"name":"LITERAL_INT", "value":"5"}, {"name":"IDENT", "value":"num2"}]}]}]}, {"name":"ASIGNACION", "value":"num1", "children": [{"name":"OPERACION", "value":"+", "children": [{"name":"IDENT", "value":"num1"}, {"name":"LITERAL_INT", "value":"1"}]}]}, {"name":"LOOP", "value":"", "children": [{"name":"SENTENCIAS", "value":"", "children": [{"name":"ASIGNACION", "value":"num2", "children": [{"name":"OPERACION", "value":"-", "children": [{"name":"IDENT", "value":"num2"}, {"name":"LITERAL_INT", "value":"1"}]}]}]}, {"name":"EXIT", "value":"", "children": [{"name":"OPERACION", "value":"==", "children": [{"name":"IDENT", "value":"num2"}, {"name":"LITERAL_INT", "value":"0"}]}]}]}]}]}]}]};

        const margin = { top: 40, right: 120, bottom: 40, left: 120 };
        const width = 2200 - margin.left - margin.right;
        const height = 1200 - margin.top - margin.bottom;

        const svg = d3.select('#tree-container')
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        let zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on('zoom', (event) => {
                svg.attr('transform', event.transform);
            });

        d3.select('svg').call(zoom);

        const root = d3.hierarchy(treeData);
        const treeLayout = d3.tree()
            .nodeSize([80, 220])
            .separation((a, b) => a.parent === b.parent ? 1.5 : 2);
        treeLayout(root);

        // Enlaces
        svg.selectAll('.link')
            .data(root.links())
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));

        // Nodos
        const node = svg.selectAll('.node')
            .data(root.descendants())
            .enter()
            .append('g')
            .attr('class', d => 'node ' + (d.children ? 'internal' : 'leaf') + (d.depth === 0 ? ' root' : ''))
            .attr('transform', d => `translate(${d.y},${d.x})`);

        // Rectángulos para nodos
        node.append('rect')
            .attr('width', d => Math.max(120, d.data.name.length * 9))
            .attr('height', 45)
            .attr('x', d => -Math.max(120, d.data.name.length * 9) / 2)
            .attr('y', -22);

        node.append('text')
            .attr('dy', '0.35em')
            .attr('text-anchor', 'middle')
            .call(wrap, 110)
            .text(d => {
                let text = d.data.name;
                if (d.data.value && d.data.value !== 'null') {
                    text += '\n' + d.data.value;
                }
                return text;
            })
            .attr('font-size', '11px')
            .attr('fill', 'white');

        // Funciones de control
        function zoomIn() {
            d3.select('svg').transition().duration(300).call(zoom.scaleBy, 1.3);
        }
        function zoomOut() {
            d3.select('svg').transition().duration(300).call(zoom.scaleBy, 0.7);
        }
        function resetZoom() {
            d3.select('svg').transition().duration(300).call(zoom.transform, d3.zoomIdentity);
        }
        function downloadSVG() {
            const svgData = new XMLSerializer().serializeToString(document.querySelector('svg'));
            const blob = new Blob([svgData], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'arbol_sintactico.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function wrap(text, width) {
            text.each(function () {
                const textSel = d3.select(this);
                const words = textSel.text().split(/\s+/).reverse();
                let word;
                let line = [];
                let lineNumber = 0;
                const lineHeight = 1.1;
                const y = textSel.attr('y');
                const dy = parseFloat(textSel.attr('dy'));
                let tspan = textSel.text(null).append('tspan').attr('x', 0).attr('y', y).attr('dy', dy + 'em');
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(' '));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(' '));
                        line = [word];
                        tspan = textSel.append('tspan').attr('x', 0).attr('y', y).attr('dy', ++lineNumber * lineHeight + dy + 'em').text(word);
                    }
                }
            });
        }
    </script>
</body>
</html>
